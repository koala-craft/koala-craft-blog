# Obsidian Log 要件定義書 v5.2

## 1. システム概要

### 1.1 目的

Obsidian Log は、開発者本人の

・学習ログ
・技術ナレッジ

を発信するためのブログアプリケーションである。

**コンテンツの構成**:

| 種別 | 立ち位置 | 説明 |
|------|----------|------|
| **Zenn インポート** | 技術ブログ | Zenn から取得した記事（articles）・スクラップ（scraps）。技術系コンテンツを GitHub 経由で同期。 |
| **Obsidian Log ブログ** | 雑多に書けるブログ | Zenn インポートから**独立した**、Obsidian Log 専用。技術に限らず様々な内容を気軽に書ける。 |

Obsidian Log ブログは Zenn とは別のデータソース・運用であり、
Obsidian Log 上で独自に管理・表示する。

---

### 1.2 デザインコンセプト

Obsidian の名前から連想される、黒くてスマートな画面を想定する。

- ダークテーマを基調としたUI
- 落ち着いたトーンで情報を整理して表示
- 知的で洗練された印象

---

## 2. 全体アーキテクチャ

[ Zenn インポート（技術ブログ） ]

GitHub Repository（Markdown / JSON）
↓
Vercel Build時取得
↓
SSG または ISR
↓
公開表示

[ Obsidian Log ブログ（雑多に書けるブログ） ]

GitHub Repository（blog/*.md）
↓
管理画面で GitHub API により作成・更新
↓
ビルド時・取得時に GitHub から読み込み
↓
公開表示

[ 認証・設定 ]

Supabase Auth（認証のみ）
↓
GitHub OAuth でログイン資格を認証

config.json（GitHub リポジトリ内）
↓
サイト設定・管理者リスト。どの GitHub アカウントを許可するか判定

※ DB（PostgreSQL）は使用しない。Supabase は認証のみ。

### 2.1 技術スタック


| 項目           | 採用技術                      |
| ---------------- | ------------------------------- |
| ホスティング   | Vercel                        |
| フロントエンド | TanStack Start                |
| 言語           | TypeScript                    |
| 認証           | Supabase Auth（GitHub OAuth） |
| 設定・管理者   | config.json（GitHub 内）      |
| コンテンツ管理 | GitHub (Markdown / JSON)      |

#### 開発時

- ナレッジ取得: ローカルの `content/` ディレクトリにモックデータを用意し、GitHub API の代わりに参照する
  - `content/articles/` … 記事の .md ファイル
  - `content/scraps/` … スクラップの .json ファイル
  - `content/blog/` … ブログの .md ファイル
  - `content/blog/assets/` … ブログ用画像・動画（開発時モック）
- 本番ビルド時のみ GitHub API で取得

#### ディレクトリ設計（ハイブリッド feature-based）

ルート定義は `src/routes/` に維持しつつ、ロジック・コンポーネントを feature 単位で分離する。

- **routes/**: TanStack Router のファイルベースルーティング。URL とページの対応のみ定義
- **features/**: 機能ごとに API・型・コンポーネントを集約（articles, scraps, blog, admin）
- **shared/**: 複数 feature で使うライブラリ（Supabase Auth クライアント、slug 検証等）・共通コンポーネント

詳細は [開発ガイド](./開発ガイド.md) を参照。

---

## 3. データ設計

### 3.1 Zenn インポート（GitHub）※技術ブログ

技術ブログとして、Zenn から取得したコンテンツ。GitHub API によりリポジトリからデータを取得する。

- **URL**: 環境変数 `GITHUB_REPO_URL` で指定。または config.json の `github_repo_url` で上書き可能（例: `https://github.com/owner/Blog-Repo`）
- **デフォルト**: 環境変数が未設定の場合はローカル `content/` を参照
- **公開範囲**: public リポジトリを想定（認証不要で取得可能）
- **Zenn との関係**: 記事・スクラップは Zenn 形式で GitHub に配置。Zenn からのエクスポート・同期で更新。

#### 取得対象ディレクトリ


| ディレクトリ | ファイル形式 | 内容                         |
| -------------- | -------------- | ------------------------------ |
| articles     | slug名.md    | Markdown形式で記事内容を取得（Zenn 形式） |
| scraps       | slug名.json  | JSON形式でscrapの内容を取得（Zenn エクスポート形式）  |

#### 記事（articles）※Zenn 形式

- ファイル形式: `slug名.md`
- Markdown形式
- Frontmatter でメタデータを管理
  - `title`: 記事タイトル
  - `createdAt` または `published_at`: 作成日時
  - `topics`: タグ（Zenn 形式）。`topics: ["a","b"]` または `topics:\n  - a\n  - b` に対応
  - `visibility`: public / private（表示制御）
  - `published`: false の場合は private 扱い

#### Scrap（scraps）データ構造※Zenn エクスポート形式

```json
{
  "title": "string",
  "closed": "boolean",
  "archived": "boolean",
  "created_at": "string",
  "comments": [
    {
      "author": "string",
      "created_at": "string",
      "body_markdown": "string",
      "body_updated_at": "string",
      "children": [
        {
          "author": "string",
          "created_at": "string",
          "body_markdown": "string",
          "body_updated_at": "string",
          "children": []
        }
      ]
    }
  ]
}
```

- `comments` はネスト可能（`children` で再帰構造）
- `body_updated_at` は任意

**タグ（末尾ブラケット記法）**:
- タイトル末尾に `[tag1] [tag2]` 形式でタグを記述可能
- 末尾に連続する `[xxx]` のみをタグとしてパースし、表示用タイトルからは除去する
- タグで一覧フィルタ可能（`/scraps?tag=xxx`）

**表示制御（スクラップ）**:
- `closed` と `archived` は Zenn エクスポート形式の互換性のためデータには含まれるが、UI では表示しない

#### Scrap 同期フロー

作者はスクラップをよく使うが、Zenn CLI 管理は難しいと考える。そのため以下の運用とする。

- **記述**: Zenn 上でスクラップを記述する
- **同期**: Zenn から手動エクスポートしたデータを GitHub に同期する
- **反映**: GitHub への同期完了後、Obsidian Log に反映される（ビルド時取得）

Zenn CLI による管理は行わない。

#### 表示制御

- public のみサイトに表示
- private はビルド時除外

---

### 3.2 Obsidian Log ブログ※雑多に書けるブログ

Zenn インポートから**独立した**、Obsidian Log 専用のブログ機能。

- **立ち位置**: 雑多に書けるブログ。技術に限らず、日記・メモ・思いつきなど様々な内容を気軽に書ける
- **技術ブログ（Zenn）との違い**: Zenn は技術系に特化。Obsidian Log ブログは形式に縛られず自由に記述
- **データソース**: **GitHub リポジトリ**（環境変数または config.json の `github_repo_url` で指定したリポジトリと同一。例: Blog-Repo）
- **保存方式**: 管理画面で保存時、GitHub API により `blog/` ディレクトリに Markdown ファイルをコミット
- **認証**: 既存の GitHub OAuth（repo 権限）を使用して書き込み

**記述形式**:

- ブログ本文は **Markdown 記法**で記載する
- 編集画面では**都度プレビューを見ながら記載**できること（ライブプレビュー対応）
- エディタとプレビューを並べて表示し、入力と同時にレンダリング結果を確認可能とする

#### 保存先・ディレクトリ構成

| ディレクトリ | 内容 |
|--------------|------|
| `articles/` | Zenn 記事（既存） |
| `scraps/` | Zenn スクラップ（既存） |
| `blog/` | Obsidian Log ブログの Markdown ファイル |
| `blog/assets/{slug}/` | ブログで参照する画像・動画（記事ごと。削除時にまとめて削除） |

#### ブログ記事のスキーマ（Markdown + Frontmatter）

**ファイル形式**: `blog/{slug}.md`

**Frontmatter**:

| フィールド | 型 | 必須 | デフォルト | 説明 |
|------------|-----|------|------------|------|
| title | string | ○ | - | 記事タイトル |
| createdAt | string | ○ | - | 作成日（YYYY-MM-DD または ISO 8601） |
| updatedAt | string | - | - | 更新日（未指定時は createdAt を使用） |
| tags | string[] | - | [] | タグ。`["a", "b"]` または YAML リスト形式 |
| visibility | 'public' \| 'private' | - | public | 表示制御。private は一覧・検索に非表示 |

**本文**: Frontmatter の `---` 以降が Markdown 本文

**slug**: ファイル名から取得（`.md` を除く）。英数字・ハイフン・アンダースコアのみ許可。

**例**:

```markdown
---
title: 今日のメモ
createdAt: 2026-02-14
updatedAt: 2026-02-15
tags: ["日記", "メモ"]
visibility: public
---

# 今日やったこと

- Obsidian Log のブログ機能を検討
- 要件定義書を更新
```

#### 添付メディア（画像・動画）の保存場所

ブログの Markdown で参照する画像・動画の保存先。

**保存先**: 同一 GitHub リポジトリ内の `blog/assets/{slug}/` ディレクトリ

**ディレクトリ構成**:

| パス | 内容 |
|------|------|
| `blog/assets/{slug}/` | 記事ごとの画像・動画。`{slug}` は記事の slug。削除時にまとめて削除するため、記事単位で格納する |

**画像**:

- 保存先: `blog/assets/{slug}/`（記事ごとに格納）
- ファイル形式: png, jpg, jpeg, gif, webp 等
- Markdown 参照例: `![説明](blog/assets/my-post/image.png)`
- アップロード時: 管理画面から添付し、GitHub API でコミット。Markdown のカーソル位置に参照を貼り付け

**動画**:

- **方式 A（リポジトリ内）**: `blog/assets/{slug}/` に保存。GitHub のファイルサイズ制限（100MB/ファイル）に注意
- **方式 B（外部 URL）**: YouTube、Vimeo 等の URL を Markdown で埋め込み。Obsidian Log 側での保存は不要
- 実装時は方式 A を基本とし、大きな動画は方式 B（外部 URL 埋め込み）を推奨

**ブログ削除時のメディア削除**:

- ブログ記事を削除する際、`blog/assets/{slug}/` 内の画像・動画も GitHub API で**同時に削除**する
- 記事単位で格納することで、削除対象を明確にし、孤立ファイルを残さない

**ファイル名**:

- 英数字・ハイフン・アンダースコアを推奨（日本語可だが URL エンコードに注意）
- `blog/assets/{slug}/` 内では重複しにくいため、`{timestamp}.{ext}` や元ファイル名のままでも可

---

### 3.3 認証・設定（Supabase Auth + config.json）

**DB は使用しない**。Supabase は認証のみ、設定は GitHub の config.json で管理する。

#### Supabase Auth（認証のみ）

- **役割**: GitHub アカウントへのログイン資格を認証する
- OAuth フロー、セッション管理、ユーザー情報（GitHub user_name）の取得
- PostgreSQL（admins, site_config 等）は使用しない

#### config.json（GitHub リポジトリ内）

リポジトリ直下の `.obsidian-log/config.json` に配置。環境変数 `GITHUB_REPO_URL` で指定したリポジトリ（例: Blog-Repo）から取得する。

```json
{
  "github_repo_url": "https://github.com/owner/Blog-Repo",
  "zenn_username": "username",
  "admins": ["github_username1", "github_username2"]
}
```

| フィールド | 説明 |
|------------|------|
| github_repo_url | コンテンツ取得元の GitHub リポジトリ URL。環境変数で上書き可能 |
| zenn_username | 記事・スクラップ詳細の「Zenn で見る」リンク用 |
| admins | 管理者として許可する GitHub ユーザー名のリスト |

**認証・認可の分担**:

| 担当 | 役割 |
|------|------|
| **Supabase Auth** | GitHub のログイン資格を認証（「この人は誰か」） |
| **config.json の admins** | どの GitHub アカウントを管理者として許可するか判定（「誰を許可するか」） |

**リポジトリ構成**（config.json の配置）:

| パス | 内容 |
|------|------|
| `.obsidian-log/config.json` | サイト設定・管理者リスト（リポジトリ直下） |

**初回セットアップ**: コンテンツ用リポジトリ（例: Blog-Repo）に `.obsidian-log/config.json` を手動で作成し、`github_repo_url` に自身のリポジトリ URL、`admins` に自分の GitHub ユーザー名を追加する。

---

## 4. ページ構成・URLルーティング

### 4.1 サイトのコンセプト

ブログサイトとして、以下のコンテンツで構成する。

- **Zenn インポート（技術ブログ）**: 記事（articles）・スクラップ（scraps）の一覧・詳細
- **Obsidian Log ブログ（雑多に書けるブログ）**: 技術に限らず様々な内容を気軽に書ける
- トップページで最新コンテンツをプレビュー

### 4.2 URL ルーティング

| パス | 説明 | 認証 |
|------|------|------|
| `/` | トップページ（ブログ） | 不要 |
| `/articles` | 記事一覧（技術ブログ・Zenn） | 不要 |
| `/articles/$slug` | 記事詳細（技術ブログ・Zenn） | 不要 |
| `/scraps` | スクラップ一覧（技術ブログ・Zenn） | 不要 |
| `/scraps/$slug` | スクラップ詳細（技術ブログ・Zenn） | 不要 |
| `/blog` | ブログ一覧（雑多に書けるブログ） | 不要 |
| `/blog/$slug` | ブログ詳細（雑多に書けるブログ） | 不要 |
| `/admin` | 管理画面トップ（ダッシュボード） | 要（GitHub OAuth + 管理者） |
| `/admin/settings` | サイト設定（GitHub URL・Zenn ユーザー名等） | 要（管理者のみ） |
| `/admin/blog` | ブログ管理（Obsidian Log ブログの CRUD） | 要（管理者のみ） |

※ 管理ルート（`/admin/*`）は、Supabase Auth でログイン後、config.json の admins に GitHub ユーザー名が含まれるか確認。非管理者は 403 またはリダイレクトする。

### 4.3 トップページの表示内容

- タイトル「Obsidian Log」
- 最新コンテンツのプレビュー（技術ブログ・雑多ブログ）
- 各セクションへのナビゲーション（記事・スクラップ・ブログ）

---

## 5. 機能要件

### 5.1 公開機能（一般ユーザー）

#### 5.1.1 Zenn インポート表示（記事・スクラップ）

**記事（articles）※Zenn 形式**

- public 記事一覧表示
- タグフィルタ（`/articles?tag=xxx`）
- タイトル・本文検索（`/articles?q=xxx`）
- 月別アーカイブ表示
- 詳細ページ表示
- Markdown レンダリング
- パンくずナビゲーション（トップ › 記事）
- Zenn ユーザー名設定時は「Zenn で見る」リンクを表示

**スクラップ（scraps）※Zenn エクスポート形式**

- スクラップ一覧表示
- タグフィルタ（`/scraps?tag=xxx`）
- タイトル・本文検索（`/scraps?q=xxx`）
- 月別アーカイブ表示
- 詳細ページ表示（コメントスレッド形式）
- Markdown レンダリング
- パンくずナビゲーション（トップ › スクラップ）
- Zenn ユーザー名設定時は「Zenn で見る」リンクを表示

---

#### 5.1.2 Obsidian Log ブログ表示※雑多に書けるブログ

技術ブログ（Zenn）とは別に、様々な内容を気軽に書けるブログ。

- 本文は Markdown で保存され、表示時にレンダリング
- ブログ記事一覧表示（`/blog`）
- ブログ記事詳細表示（`/blog/$slug`）
- タグフィルタ・検索（実装時に定義）
- パンくずナビゲーション（トップ › ブログ）
- Markdown レンダリング

※ Zenn へのリンクは不要（Obsidian Log 独自コンテンツのため）

---

**slug の検証（パストラバーサル対策）**:
- `/articles/$slug`, `/scraps/$slug`, `/blog/$slug` の slug は英数字・ハイフン・アンダースコアのみ許可
- `..`, `/` を含む場合は拒否

**Markdown レンダリング（XSS 対策）**:
- サニタイズ済みの Markdown レンダラーを使用
- 必要に応じて DOMPurify 等で HTML をサニタイズ

**更新方式**: SSG または ISR

---

### 5.2 管理機能（Admin）

#### 5.2.1 サイト設定（ダッシュボード）

管理画面のサイト設定（`/admin/settings`）から以下を設定可能。

- **GitHub リポジトリ URL**: コンテンツ取得元の URL。config.json に保存（GitHub API で更新）
- **Zenn ユーザー名**: 記事・スクラップ詳細の「Zenn で見る」リンク用。config.json に保存
- **管理者リスト（admins）**: 許可する GitHub ユーザー名。config.json に保存
- 変更後、次回ビルド（または ISR 再検証）時に反映

**GitHub URL の検証（SSRF 対策）**:
- 形式: `https://github.com/{owner}/{repo}` のみ許可
- ホストを `github.com` に限定
- 上記以外は保存時・取得時に拒否する

#### 5.2.2 Zenn インポート管理

**記事（articles）・スクラップ（scraps）**

- GitHub にて Markdown / JSON を編集、または Zenn からエクスポートして GitHub に同期
- push で自動反映（Webhook想定）
- Obsidian Log の Web UI での CRUD は実装しない

#### 5.2.3 Obsidian Log ブログ管理※雑多に書けるブログ

**ブログ記事**

- Obsidian Log 管理画面から作成・編集・削除
- 保存時は **GitHub API**（`PUT /repos/{owner}/{repo}/contents/blog/{slug}.md`）でリポジトリにコミット
- 本文は **Markdown 記法**で記載する
- **都度プレビューを見ながら記載**できること（ライブプレビュー）
  - エディタとプレビューを並べて表示
  - 入力と同時にレンダリング結果を確認可能
- 技術に限らず様々な内容を気軽に書ける
- Zenn インポート（技術ブログ）とは**独立**。Zenn への同期は行わない

**添付メディア**:

- 編集画面で画像・動画を**添付して Markdown に貼り付け**できること
  - アップロード後、カーソル位置に `![alt](path)` 形式の参照を自動挿入
  - ドラッグ＆ドロップまたはファイル選択で添付可能
- 添付ファイルは `blog/assets/{slug}/` に GitHub API でコミット
- ブログ削除時、その記事に紐づく画像・動画（`blog/assets/{slug}/` 内）も**同時に削除**する

**GitHub 書き込みに必要な前提**:

- GitHub OAuth に `repo` スコープを含める（既存アプリで対応済み）
- 対象リポジトリは環境変数または config.json の `github_repo_url` で指定。articles と同一リポジトリ（例: Blog-Repo）

---

#### 5.2.4 認証・管理者

**認証方式**

- Supabase Auth の **GitHub OAuth** でログイン
- Supabase Auth は **GitHub アカウントへのログイン資格を認証**する役割
- パスワード管理不要、コンテンツ管理（GitHub）とアカウントを統一
- ブログの GitHub 書き込みには OAuth の `repo` スコープを使用

**管理者判定**

- config.json の `admins` に、ログイン中の GitHub ユーザー名が含まれるかで判定
- **どの GitHub アカウントを管理者として許可するか**は config.json で定義
- 初回セットアップ: リポジトリに config.json を作成し、自分の GitHub ユーザー名を admins に追加

**ログイン UI 仕様**

| 項目 | 仕様 |
|------|------|
| 管理画面へのアクセス | `/admin` に直接アクセス。ヘッダーナビには管理者ログイン時のみ「管理」リンク（`/admin`）を表示 |
| 未ログイン時の `/admin/*` アクセス | ログインフォームを表示。ログイン後は管理画面へ遷移 |
| ログイン方式 | Supabase Auth の `signInWithOAuth({ provider: 'github' })` を使用 |
| ログアウト | 管理画面内にログアウトボタンを配置。`signOut()` でログアウト後、トップへ遷移 |
| ログイン状態の表示 | 管理画面ヘッダーにログイン中のユーザー表示（GitHub ユーザー名等）とログアウトボタン |
| 管理者以外のログイン | GitHub でログインしたが config.json の admins に未登録の場合、「管理者権限がありません」メッセージを表示し、ログアウトを促す |

---

## 6. 非機能要件

### 6.1 パフォーマンス

- 初期表示 1秒以内
- Lighthouse 90以上

---

### 6.2 コスト

- Vercel無料枠
- Supabase無料枠
- GitHub無料枠

月額コスト 0円想定

---

### 6.3 セキュリティ

- Supabase は認証のみ使用。anon key で十分（Service Role Key は不要）
- privateナレッジはビルド除外

**実装時のセキュリティ要件**:

| 項目 | 対策 |
|------|------|
| config.json（github_repo_url） | SSRF 対策: `https://github.com/{owner}/{repo}` 形式のみ許可、ホストを github.com に限定 |
| config.json（zenn_username） | 小文字英数字・ハイフン・アンダースコアのみ許可、50文字以内 |
| config.json | 機密情報（トークン等）は保存しない。GitHub リポジトリ内に配置 |
| 管理ルート（/admin/*） | サーバー側で管理者チェック。非管理者は 403 またはリダイレクト |
| slug（articles/scraps/blog） | パストラバーサル対策: 英数字・ハイフン・アンダースコアのみ許可 |
| ブログ GitHub 書き込み | 対象リポジトリは config.json または環境変数で指定。パスは `blog/` 以下に制限 |
| Markdown 表示 | XSS 対策: サニタイズ済みレンダラー、必要に応じて DOMPurify |

**その他のセキュリティ要件**:

| 項目 | 対策 |
|------|------|
| セキュリティヘッダー | Content-Security-Policy, X-Frame-Options, X-Content-Type-Options: nosniff, Referrer-Policy を設定（vercel.json 等） |
| エラーハンドリング | 本番ではスタックトレース・内部エラーをクライアントに返さない。ログに機密情報を含めない |
| 依存関係 | `npm audit` / `pnpm audit` を定期実行。Dependabot 等で更新 |
| GitHub Webhook（将来） | 再ビルド用 Webhook 導入時は `X-Hub-Signature-256` で署名検証。不一致は拒否 |
| OAuth | Supabase の許可リダイレクト URI のみ使用。state による CSRF 対策は Supabase が実施 |
| 環境変数 | 機密情報は Vercel 環境変数で管理。クライアント公開用（NEXT_PUBLIC_ 等）に機密を含めない |
| レート制限 | 独自 API 追加時は検討。Supabase は標準でレート制限あり |
| プレビュー環境 | Vercel プレビューデプロイで本番 Supabase を参照しない。環境変数で Supabase プロジェクトを切り替える |
| OAuth リダイレクト | Supabase の許可リダイレクト URI を本番・開発で正しく設定。ワイルドカードで緩くしすぎない |
| 入力長制限 | config.json の各フィールドに長さ上限を設ける（巨大ペイロードによる負荷対策） |
| 環境分離 | 開発・ステージング・本番で Supabase プロジェクトを分ける |
| CI/CD | GitHub Actions 等でテスト・ビルドを自動化。シークレットは GitHub Secrets で管理 |

---

## 7. 将来拡張

- GitHub Webhookによる自動再ビルド
- RSS / Atom フィード
- タグクラウド可視化
- LLMによるナレッジ自動タグ付け
- 知識グラフ構造表示

---

## 8. 設計思想

1. 技術ブログ（Zenn インポート）は Git（GitHub）で管理する
2. 雑多に書けるブログ（Obsidian Log ブログ）は Zenn から独立し、Obsidian Log 専用のデータで管理する
3. 認証は Supabase Auth のみ。サイト設定・管理者リストは config.json（GitHub 内）で管理
4. 外部サービスに過度に依存しない
5. 最小構成で最大表現
6. 管理操作はできる限りコード管理で行う

---
